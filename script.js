class MobileLineManager{constructor(){this.lines=JSON.parse(localStorage.getItem('mobileLines'))||[],this.carriers=JSON.parse(localStorage.getItem('carriers'))||[],this.people=JSON.parse(localStorage.getItem('people'))||[],this.currentSort={field:'contractDate',direction:'asc'},this.searchText='',this.filters={carrier:'',owner:'',user:'',hasBullet:''},this.migrateOldData(),this.initializeApp()}migrateOldData(){const a=JSON.parse(localStorage.getItem('owners'))||[],b=JSON.parse(localStorage.getItem('users'))||[];a.length>0||b.length>0&&(this.people=[...new Set([...this.people,...a,...b])],localStorage.setItem('people',JSON.stringify(this.people)),localStorage.removeItem('owners'),localStorage.removeItem('users'),this.lines.forEach(a=>{void 0===a.hasBullet&&(a.hasBullet=!1)}),localStorage.setItem('mobileLines',JSON.stringify(this.lines)))}initializeApp(){this.setupFormHandlers(),this.setupSelectHandlers(),this.setupAddOptionHandlers(),this.setupDeleteOptionHandlers(),this.updateSelectOptions(),this.setupSortHandlers(),this.setupPhoneNumberValidation(),this.setupSearchAndFilter(),this.displayLines(),this.setupContractPeriodHandler(),this.setupFormToggle()}setupSearchAndFilter(){const a=document.getElementById('searchInput'),b=document.getElementById('filterCarrier'),c=document.getElementById('filterOwner'),d=document.getElementById('filterUser'),e=document.getElementById('filterBullet');this.updateFilterOptions(),a.addEventListener('input',()=>{this.searchText=a.value.toLowerCase(),this.displayLines()}),b.addEventListener('change',()=>{this.filters.carrier=b.value,this.displayLines()}),c.addEventListener('change',()=>{this.filters.owner=c.value,this.displayLines()}),d.addEventListener('change',()=>{this.filters.user=d.value,this.displayLines()}),e.addEventListener('change',()=>{this.filters.hasBullet=e.value,this.displayLines()})}updateFilterOptions(){const a=document.getElementById('filterCarrier'),b=document.getElementById('filterOwner'),c=document.getElementById('filterUser');a.innerHTML='<option value="">キャリア: すべて</option>',[...new Set(this.lines.map(a=>a.carrier))].filter(a=>a).sort().forEach(b=>{const c=document.createElement('option');c.value=b,c.textContent=b,a.appendChild(c)}),b.innerHTML='<option value="">名義: すべて</option>',[...new Set(this.lines.map(a=>a.owner))].filter(a=>a).sort().forEach(a=>{const c=document.createElement('option');c.value=a,c.textContent=a,b.appendChild(c)}),c.innerHTML='<option value="">利用者: すべて</option>',[...new Set(this.lines.map(a=>a.user))].filter(a=>a).sort().forEach(a=>{const b=document.createElement('option');b.value=a,b.textContent=a,c.appendChild(b)})}setupFormToggle(){const a=document.getElementById('toggleForm'),b=document.getElementById('formSection');a.addEventListener('click',()=>{b.classList.toggle('hidden')})}setupPhoneNumberValidation(){const a=document.getElementById('phoneNumber');a.addEventListener('input',b=>{let c=b.target.value.replace(/[^\d-]/g,'');c.length>0&&(c=c.replace(/^(\d{2,3})(\d{4})(\d{4})$/,'$1-$2-$3')),b.target.value=c})}setupAddOptionHandlers(){document.querySelectorAll('.add-option-btn').forEach(a=>{a.addEventListener('click',b=>{const c=b.target.dataset.target;this.addOption(c)})})}addOption(a){const b=`new${a.charAt(0).toUpperCase()+a.slice(1)}`,c=document.getElementById(b).value.trim();if(c){if('owner'===a||'user'===a){if(!this.people.includes(c)){this.people.push(c),localStorage.setItem('people',JSON.stringify(this.people)),this.updatePeopleSelectOptions()}}else{const b=`${a}s`;!this[b].includes(c)&&(this[b].push(c),localStorage.setItem(b,JSON.stringify(this[b])),this.updateSelectOptions())}document.getElementById(a).value=c,document.getElementById(b).value=''}}setupDeleteOptionHandlers(){document.querySelectorAll('.delete-option-btn').forEach(a=>{a.addEventListener('click',b=>{const c=b.target.dataset.target;this.showDeleteOptionsModal(c)})})}showDeleteOptionsModal(a){const b=document.querySelector('.option-modal');b&&b.remove();let c;if(c='owner'===a||'user'===a?this.people:this[`${a}s`],!c||0===c.length)return void alert('削除可能な選択肢がありません。');const d=document.createElement('div');d.className='modal-overlay',document.body.appendChild(d);const e=document.createElement('div');e.className='option-modal',e.innerHTML=`
            <h3>${this.getTargetLabel(a)}の選択肢削除</h3>
            <ul>
                ${c.map(b=>`
                    <li>
                        ${b}
                        <button onclick="mobileLineManager.deleteOption('${a}', '${b}')">削除</button>
                    </li>
                `).join('')}
            </ul>
            <button onclick="this.closest('.option-modal').remove();document.querySelector('.modal-overlay').remove()">閉じる</button>
        `,document.body.appendChild(e)}deleteOption(a,b){confirm(`${b}を削除してもよろしいですか？`)&&('owner'===a||'user'===a?(this.people=this.people.filter(a=>a!==b),localStorage.setItem('people',JSON.stringify(this.people)),this.updatePeopleSelectOptions()):(this[`${a}s`]=this[`${a}s`].filter(a=>a!==b),localStorage.setItem(`${a}s`,JSON.stringify(this[`${a}s`])),this.updateSelectOptions()),document.querySelector('.option-modal').remove(),document.querySelector('.modal-overlay').remove())}getTargetLabel(a){return{carrier:'キャリア',owner:'名義',user:'利用者'}[a]||a}setupSelectHandlers(){[{select:'carrier',new:'newCarrier'},{select:'owner',new:'newOwner'},{select:'user',new:'newUser'}].forEach(({select:a,new:b})=>{const c=document.getElementById(a),d=document.getElementById(b),e=c.parentElement.querySelector('.add-option-btn');c.addEventListener('change',()=>{'other'===c.value?d.classList.remove('hidden'):(d.classList.add('hidden'),d.value='')}),e.addEventListener('click',()=>{const e=d.value.trim();e&&('owner'===a||'user'===a?!this.people.includes(e)&&(this.people.push(e),localStorage.setItem('people',JSON.stringify(this.people)),this.updatePeopleSelectOptions()):!this[`${a}s`].includes(e)&&(this[`${a}s`].push(e),localStorage.setItem(`${a}s`,JSON.stringify(this[`${a}s`])),this.updateSelectOptions()),d.value='',c.value=e)})})}updateSelectOptions(){const a=document.getElementById('carrier'),b=a.value;a.innerHTML='<option value="">選択してください</option>';let c=JSON.parse(localStorage.getItem('carriers'))||[];c=[...new Set(c)].sort(),c.forEach(b=>{const c=document.createElement('option');c.value=b,c.textContent=b,a.appendChild(c)});const d=document.createElement('option');d.value='other',d.textContent='新規追加',a.appendChild(d),b&&(c.includes(b)||'other'===b)&&(a.value=b),this.updatePeopleSelectOptions(),this.updateFilterOptions()}updatePeopleSelectOptions(){['owner','user'].forEach(a=>{const b=document.getElementById(a),c=b.value;b.innerHTML='<option value="">選択してください</option>';let d=[...new Set(this.people)].sort();d.forEach(a=>{const c=document.createElement('option');c.value=a,c.textContent=a,b.appendChild(c)});const e=document.createElement('option');e.value='other',e.textContent='新規追加',b.appendChild(e),c&&(d.includes(c)||'other'===c)&&(b.value=c)}),this.updateFilterOptions()}calculateCancellationDate(a){if(!a.contractDate||!a.contractPeriod)return null;const b=new Date(a.contractDate);return b.setMonth(b.getMonth()+parseInt(a.contractPeriod)),b}isExpiryPassed(a){if(!a)return!1;const b=new Date;return b.setHours(0,0,0,0),a<b}setupSortHandlers(){document.querySelectorAll('th.sortable').forEach(a=>{a.addEventListener('click',()=>{const b=a.dataset.sort;this.handleSort(b)})})}handleSort(a){document.querySelectorAll('th.sortable').forEach(b=>{b.dataset.sort===a?this.currentSort.field===a?(this.currentSort.direction='asc'===this.currentSort.direction?'desc':'asc',b.classList.toggle('sort-asc','asc'===this.currentSort.direction),b.classList.toggle('sort-desc','desc'===this.currentSort.direction)):(this.currentSort.field=a,this.currentSort.direction='asc',b.classList.add('sort-asc'),b.classList.remove('sort-desc')):b.classList.remove('sort-asc','sort-desc')}),this.sortLines(),this.displayLines()}sortLines(){const{field:a,direction:b}=this.currentSort;this.lines.sort((c,d)=>{let e,f;if('cancellationDate'===a){if(e=this.calculateCancellationDate(c),f=this.calculateCancellationDate(d),!e&&!f)return 0;if(!e)return'asc'===b?1:-1;if(!f)return'asc'===b?-1:1}else if(e=c[a]||'',f=d[a]||'','contractDate'===a)e=e?new Date(e):new Date(0),f=f?new Date(f):new Date(0);else if('contractPeriod'===a)e=e?Number(e):0,f=f?Number(f):0;else{if('hasBullet'===a)return'asc'===b?e===f?0:e?-1:1:e===f?0:e?1:-1;e=e?e.toString().toLowerCase():'',f=f?f.toString().toLowerCase():''}return e<f?'asc'===b?-1:1:e>f?'asc'===b?1:-1:0})}setupFormHandlers(){const a=document.getElementById('mobileLineForm');a.addEventListener('submit',a=>{a.preventDefault(),this.validateForm()&&this.handleFormSubmit()})}validateForm(){const a=document.getElementById('phoneNumber').value;return!!a.match(/^\d{2,3}-\d{4}-\d{4}$/)||(alert('電話番号の形式が正しくありません。\n例：090-1234-5678'),!1)}setupContractPeriodHandler(){const a=document.getElementById('contractDate'),b=document.getElementById('contractPeriod'),c=document.getElementById('cancellationDate'),d=()=>{if(a.value&&b.value){const d=new Date(a.value);d.setMonth(d.getMonth()+parseInt(b.value)),c.value=d.toLocaleDateString('ja-JP')}else c.value=''};a.addEventListener('change',d),b.addEventListener('input',d)}duplicateLine(a){const b=this.lines.find(b=>b.id===a);if(b){const a={...b};delete a.id,document.getElementById('mobileLineForm').dataset.editId='',this.setFormData(a);const c=document.getElementById('formSection');c.classList.remove('hidden'),c.scrollIntoView({behavior:'smooth'})}}setFormData(a){document.getElementById('phoneNumber').value=a.phoneNumber||'',document.getElementById('contractDate').value=a.contractDate||'',document.getElementById('contractPeriod').value=a.contractPeriod||'',document.getElementById('cancellationDate').value=a.cancellationDate||'',document.getElementById('notes').value=a.notes||'',document.getElementById('hasBullet').checked=a.hasBullet||!1,this.setSelectValue('carrier',a.carrier||''),this.setSelectValue('owner',a.owner||''),this.setSelectValue('user',a.user||'')}setSelectValue(a,b){const c=document.getElementById(a),d=`new${a.charAt(0).toUpperCase()+a.slice(1)}`,e=document.getElementById(d);if(!b)return c.value='',e.value='',void e.classList.add('hidden');let f;f='owner'===a||'user'===a?this.people:this[`${a}s`],f.includes(b)?(c.value=b,e.value='',e.classList.add('hidden')):('owner'===a||'user'===a?(this.people.push(b),localStorage.setItem('people',JSON.stringify(this.people)),this.updatePeopleSelectOptions()):(this[`${a}s`].push(b),localStorage.setItem(`${a}s`,JSON.stringify(this[`${a}s`])),this.updateSelectOptions()),c.value=b,e.classList.add('hidden'))}handleFormSubmit(){const a=this.getFormData();['carrier','owner','user'].forEach(b=>{const c=document.getElementById(b);if('other'===c.value){const c=document.getElementById(`new${b.charAt(0).toUpperCase()+b.slice(1)}`),d=c.value.trim();d?'owner'===b||'user'===b?(!this.people.includes(d)&&(this.people.push(d),localStorage.setItem('people',JSON.stringify(this.people))),a[b]=d):(!this[`${b}s`].includes(d)&&(this[`${b}s`].push(d),localStorage.setItem(`${b}s`,JSON.stringify(this[`${b}s`]))),a[b]=d):a[b]=''}}),localStorage.setItem('mobileLines',JSON.stringify(this.lines)),this.updateSelectOptions(),this.updatePeopleSelectOptions(),this.updateFilterOptions(),this.sortLines(),this.displayLines(),document.getElementById('mobileLineForm').reset(),document.getElementById('formSection').classList.add('hidden')}getFormData(){const a={id:document.getElementById('mobileLineForm').dataset.editId||'',phoneNumber:document.getElementById('phoneNumber').value.trim(),contractDate:document.getElementById('contractDate').value,contractPeriod:document.getElementById('contractPeriod').value.trim()||'',cancellationDate:document.getElementById('cancellationDate').value,notes:document.getElementById('notes').value.trim()||'',hasBullet:document.getElementById('hasBullet').checked};return['carrier','owner','user'].forEach(b=>{const c=document.getElementById(b);if('other'===c.value){const c=document.getElementById(`new${b.charAt(0).toUpperCase()+b.slice(1)}`);a[b]=c.value.trim()||''}else a[b]=c.value||''}),a}displayLines(){const a=document.querySelector('#mobileLineTable tbody');a.innerHTML='';const b=this.lines.filter(a=>{const b=!this.searchText||Object.values(a).some(b=>'boolean'==typeof b?!1:b&&b.toString().toLowerCase().includes(this.searchText)),c=!this.filters.carrier||a.carrier===this.filters.carrier,d=!this.filters.owner||a.owner===this.filters.owner,e=!this.filters.user||a.user===this.filters.user,f=''===this.filters.hasBullet||'true'===this.filters.hasBullet&&a.hasBullet;return b&&c&&d&&e&&f});b.forEach(b=>{let c='',d='';if(b.contractDate&&b.contractPeriod){const a=new Date(b.contractDate);a.setMonth(a.getMonth()+parseInt(b.contractPeriod)),c=a.toLocaleDateString('ja-JP'),this.isExpiryPassed(a)&&(d='expiry-passed')}const e=`
                <div class="bullet-toggle ${b.hasBullet?'':'inactive'}" 
                     onclick="mobileLineManager.toggleBullet('${b.id}')" 
                     title="${b.hasBullet?'弾として利用中':'非弾'}">${b.hasBullet?'弾':'-'}</div>
            `,f=document.createElement('tr');f.innerHTML=`
                <td>${b.phoneNumber}</td>
                <td>${b.contractDate?new Date(b.contractDate).toLocaleDateString('ja-JP'):''}</td>
                <td>${b.carrier||''}</td>
                <td>${b.contractPeriod?b.contractPeriod+'ヶ月':''}</td>
                <td class="${d}">${c}</td>
                <td>${b.owner||''}</td>
                <td>${b.user||''}</td>
                <td class="center-align">${e}</td>
                <td>${b.notes||''}</td>
                <td>
                    <button class="edit-btn" onclick="mobileLineManager.editLine('${b.id}')">編集</button>
                    <button class="delete-btn" onclick="mobileLineManager.deleteLine('${b.id}')">削除</button>
                    <button class="duplicate-btn" onclick="mobileLineManager.duplicateLine('${b.id}')">複製</button>
                </td>
            `,a.appendChild(f)})}toggleBullet(a){const b=this.lines.findIndex(b=>b.id===a);b>=0&&(this.lines[b].hasBullet=!this.lines[b].hasBullet,localStorage.setItem('mobileLines',JSON.stringify(this.lines)),this.displayLines())}editLine(a){const b=this.lines.find(b=>b.id===a);if(!b)return;const c=document.getElementById('mobileLineForm');c.dataset.editId=a,this.updateSelectOptions(),this.updatePeopleSelectOptions(),document.getElementById('phoneNumber').value=b.phoneNumber||'',document.getElementById('contractDate').value=b.contractDate||'',document.getElementById('contractPeriod').value=b.contractPeriod||'',document.getElementById('cancellationDate').value=b.cancellationDate||'',document.getElementById('notes').value=b.notes||'',document.getElementById('hasBullet').checked=b.hasBullet||!1,['carrier','owner','user'].forEach(a=>{const c=document.getElementById(a),d=`new${a.charAt(0).toUpperCase()+a.slice(1)}`,e=document.getElementById(d),f=b[a]||'';if(!f)return c.value='',e.value='',void e.classList.add('hidden');let g;if(g='owner'===a||'user'===a?this.people:this[`${a}s`],g.includes(f))c.value=f,e.value='',e.classList.add('hidden');else{if('owner'===a||'user'===a)this.people.push(f),localStorage.setItem('people',JSON.stringify(this.people)),this.updatePeopleSelectOptions();else{if(!this[`${a}s`].includes(f)){const b=`${a}s`;this[b].push(f),localStorage.setItem(b,JSON.stringify(this[b])),this.updateSelectOptions()}}c.value=f,e.classList.add('hidden')}});const d=document.getElementById('formSection');d.classList.remove('hidden'),d.scrollIntoView({behavior:'smooth'})}deleteLine(a){confirm('本当に削除しますか？')&&(this.lines=this.lines.filter(b=>b.id!==a),localStorage.setItem('mobileLines',JSON.stringify(this.lines)),this.displayLines())}}const mobileLineManager=new MobileLineManager;